# üìã API Zahtev za e-smart Pisarnicu

## üéØ TOK PODATAKA: Zahtevi ‚Üí Re≈°enja ‚Üí T1/T2 ‚Üí ≈†tampanje

### **POST /api/pisarnica/zahtevi**

**Opis:** Endpoint koji vraƒáa sve zahteve (ruƒçno upisane na ≈°alterima) iz pisarnice za broj XIX0255.

---

## üìã ZAHTEVANI PODACI

### **1. ZAHTEVI (ruƒçno upisani na ≈°alterima)**
```json
{
  "zahtevId": 12345,
  "brojZahteva": "XIX0255",
  "nazivZahteva": "Zahtev za socijalnu za≈°titu",
  "status": "PODNET",
  "datumPodnosenja": "2024-01-15",
  "salterId": 1,
  "salterNaziv": "≈†alter 1 - Socijalna za≈°tita",
  "kategorijaId": 1,
  "kategorijaNaziv": "Socijalna za≈°tita"
}
```

### **2. UGRO≈ΩENA LICA IZ ZAHTEVA**
```json
{
  "ugrozenoLiceId": 1,
  "zahtevId": 12345,  // ‚Üê OBAVEZNO! (veza sa zahtevom)
  "redniBroj": "RB001",
  "ime": "Marko",
  "prezime": "Markoviƒá",
  "jmbg": "1234567890123",
  "pttBroj": "11000",
  "gradOpstina": "Beograd",
  "mesto": "Zvezdara",
  "ulicaIBroj": "Kralja Milana 1",
  "brojClanovaDomacinstva": 3,
  "osnovSticanjaStatusa": "SOC",
  "edBroj": "ED123456",
  "potrosnjaKwh": 100,
  "zagrevanaPovrsinaM2": 50,
  "iznosUmanjenjaSaPdv": 1500.00,
  "brojRacuna": "123-456-789",
  "datumIzdavanjaRacuna": "2024-01-15",
  "datumTrajanjaPrava": "2024-12-31"
}
```

---

## üîå API SPECIFIKACIJA

### **Endpoint:**
```
POST /api/pisarnica/sync
```

### **Headers:**
```
Content-Type: application/json
Authorization: Bearer {token}
```

### **Request Body:**
```json
{
  "sekretarijatId": 1,
  "brojZahteva": "XIX0255",
  "datumOd": "2024-01-01",
  "datumDo": "2024-12-31",
  "status": "PODNET"
}
```

### **Response Format:**
```json
{
  "success": true,
  "message": "Podaci uspe≈°no uƒçitani",
  "data": {
    "zahtevi": [
      {
        "zahtevId": 12345,
        "brojZahteva": "XIX0255",
        "nazivZahteva": "Zahtev za socijalnu za≈°titu",
        "status": "PODNET",
        "datumPodnosenja": "2024-01-15",
        "salterId": 1,
        "salterNaziv": "≈†alter 1 - Socijalna za≈°tita",
        "kategorijaId": 1,
        "kategorijaNaziv": "Socijalna za≈°tita",
        "ugrozenaLica": [
          {
            "ugrozenoLiceId": 1,
            "zahtevId": 12345,
            "redniBroj": "RB001",
            "ime": "Marko",
            "prezime": "Markoviƒá",
            "jmbg": "1234567890123",
            "pttBroj": "11000",
            "gradOpstina": "Beograd",
            "mesto": "Zvezdara",
            "ulicaIBroj": "Kralja Milana 1",
            "brojClanovaDomacinstva": 3,
            "osnovSticanjaStatusa": "SOC",
            "edBroj": "ED123456",
            "potrosnjaKwh": 100,
            "zagrevanaPovrsinaM2": 50,
            "iznosUmanjenjaSaPdv": 1500.00,
            "brojRacuna": "123-456-789",
            "datumIzdavanjaRacuna": "2024-01-15",
            "datumTrajanjaPrava": "2024-12-31"
          }
        ]
      }
    ]
  }
}
```

---

## üìã OBAVEZNI PODACI

### **1. ZAHTEVI (ruƒçno upisani na ≈°alterima)**
- ‚úÖ `zahtevId` - jedinstveni ID zahteva
- ‚úÖ `brojZahteva` - broj zahteva (XIX0255)
- ‚úÖ `nazivZahteva` - naziv zahteva
- ‚úÖ `status` - status zahteva (PODNET, U_OBRADI, ODOBREN, ODBIJEN)
- ‚úÖ `datumPodnosenja` - datum podno≈°enja zahteva
- ‚úÖ `salterId` - ID ≈°altera gde je podnet zahtev
- ‚úÖ `salterNaziv` - naziv ≈°altera
- ‚úÖ `kategorijaId` - ID kategorije
- ‚úÖ `kategorijaNaziv` - naziv kategorije

### **2. UGRO≈ΩENA LICA**
- ‚úÖ `ugrozenoLiceId` - ID ugro≈æenog lica
- ‚úÖ `zahtevId` - ID zahteva (OBAVEZNO!)
- ‚úÖ `redniBroj` - redni broj
- ‚úÖ `ime` - ime
- ‚úÖ `prezime` - prezime
- ‚úÖ `jmbg` - JMBG
- ‚úÖ `pttBroj` - PTT broj
- ‚úÖ `gradOpstina` - grad/op≈°tina
- ‚úÖ `mesto` - mesto
- ‚úÖ `ulicaIBroj` - ulica i broj
- ‚úÖ `brojClanovaDomacinstva` - broj ƒçlanova domaƒáinstva
- ‚úÖ `osnovSticanjaStatusa` - osnov sticanja statusa (MP, NSP, DD, UDTNP)
- ‚úÖ `edBroj` - ED broj
- ‚úÖ `potrosnjaKwh` - potro≈°nja u kWh
- ‚úÖ `zagrevanaPovrsinaM2` - zagrevana povr≈°ina u m¬≤
- ‚úÖ `iznosUmanjenjaSaPdv` - iznos umanjenja sa PDV-om
- ‚úÖ `brojRacuna` - broj raƒçuna
- ‚úÖ `datumIzdavanjaRacuna` - datum izdavanja raƒçuna
- ‚úÖ `datumTrajanjaPrava` - datum trajanja prava

---

## üîß TEHNIƒåKI ZAHTEVI

### **Autentifikacija:**
- JWT token u Authorization header-u
- Ili API key u header-u

### **Format datuma:**
- ISO 8601 format: `YYYY-MM-DD`
- Primer: `2024-01-15`

### **Format brojeva:**
- Decimalni brojevi sa taƒçkom: `1500.00`
- Celi brojevi: `12345`

### **Encoding:**
- UTF-8 encoding
- Cyrillic karakteri podr≈æani

### **Rate Limiting:**
- **Maksimum zahteva:** 1000 zahteva po minuti
- **Burst limit:** 100 zahteva u 10 sekundi
- **Timeout:** 60 sekundi
- **Retry policy:** 3 poku≈°aja sa eksponencijalnim backoff-om
- **Rate limit headers:**
  - `X-RateLimit-Limit` - maksimum zahteva
  - `X-RateLimit-Remaining` - preostali zahtevi
  - `X-RateLimit-Reset` - vreme resetovanja (Unix timestamp)
- **HTTP status kodovi:**
  - `429 Too Many Requests` - prekoraƒçen limit
  - `503 Service Unavailable` - privremeno preoptereƒáenje

---

## üìù PRIMER KORI≈†ƒÜENJA

### **JavaScript/TypeScript sa Rate Limiting:**
```javascript
// Funkcija za retry sa eksponencijalnim backoff-om
async function fetchWithRetry(url, options, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch(url, options);
      
      // Proveri rate limit headers
      const rateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
      const rateLimitReset = response.headers.get('X-RateLimit-Reset');
      
      if (response.status === 429) {
        const resetTime = parseInt(rateLimitReset) * 1000;
        const waitTime = resetTime - Date.now();
        console.log(`Rate limit exceeded. Waiting ${waitTime}ms until reset.`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
        continue;
      }
      
      if (response.status === 503) {
        const backoffTime = Math.pow(2, attempt) * 1000; // Eksponencijalni backoff
        console.log(`Service unavailable. Retrying in ${backoffTime}ms (attempt ${attempt}/${maxRetries})`);
        await new Promise(resolve => setTimeout(resolve, backoffTime));
        continue;
      }
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      if (attempt === maxRetries) {
        throw error;
      }
      const backoffTime = Math.pow(2, attempt) * 1000;
      console.log(`Request failed. Retrying in ${backoffTime}ms (attempt ${attempt}/${maxRetries})`);
      await new Promise(resolve => setTimeout(resolve, backoffTime));
    }
  }
}

// Kori≈°ƒáenje sa rate limiting podr≈°kom
const response = await fetchWithRetry('/api/pisarnica/sync', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({
    sekretarijatId: 1,
    brojPredmeta: 'XIX0255',
    datumOd: '2024-01-01',
    datumDo: '2024-12-31',
    status: 'AKTIVAN'
  })
});

console.log('Predmeti:', response.data.predmeti);
```

### **cURL sa Rate Limiting:**
```bash
# Osnovni poziv
curl -X POST "https://pisarnica-api.com/api/pisarnica/sync" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "sekretarijatId": 1,
    "brojPredmeta": "XIX0255",
    "datumOd": "2024-01-01",
    "datumDo": "2024-12-31",
    "status": "AKTIVAN"
  }' \
  -v  # Verbose output za rate limit headers

# Proveri rate limit headers
curl -I "https://pisarnica-api.com/api/pisarnica/sync" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### **Python sa Rate Limiting:**
```python
import requests
import time
import math

def fetch_with_retry(url, headers, data, max_retries=3):
    for attempt in range(1, max_retries + 1):
        try:
            response = requests.post(url, headers=headers, json=data, timeout=60)
            
            # Proveri rate limit headers
            rate_limit_remaining = response.headers.get('X-RateLimit-Remaining')
            rate_limit_reset = response.headers.get('X-RateLimit-Reset')
            
            if response.status_code == 429:
                reset_time = int(rate_limit_reset)
                wait_time = reset_time - int(time.time())
                print(f"Rate limit exceeded. Waiting {wait_time}s until reset.")
                time.sleep(wait_time)
                continue
                
            if response.status_code == 503:
                backoff_time = math.pow(2, attempt)
                print(f"Service unavailable. Retrying in {backoff_time}s (attempt {attempt}/{max_retries})")
                time.sleep(backoff_time)
                continue
                
            if not response.ok:
                raise Exception(f"HTTP {response.status_code}: {response.text}")
                
            return response.json()
            
        except Exception as error:
            if attempt == max_retries:
                raise error
            backoff_time = math.pow(2, attempt)
            print(f"Request failed. Retrying in {backoff_time}s (attempt {attempt}/{max_retries})")
            time.sleep(backoff_time)

# Kori≈°ƒáenje
headers = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_TOKEN'
}

data = {
    'sekretarijatId': 1,
    'brojPredmeta': 'XIX0255',
    'datumOd': '2024-01-01',
    'datumDo': '2024-12-31',
    'status': 'AKTIVAN'
}

response = fetch_with_retry('https://pisarnica-api.com/api/pisarnica/sync', headers, data)
print('Predmeti:', response['data']['predmeti'])
```

---

## ‚ö†Ô∏è VA≈ΩNE NAPOMENE

1. **`zahtevId` je OBAVEZAN** za svako ugro≈æeno lice
2. **Zahtevi su ruƒçno upisani** na ≈°alterima pisarnice
3. **Osnovni podaci** o ugro≈æenim licima iz zahteva
4. **Energetski podaci** (ED broj, potro≈°nja, povr≈°ina)
5. **Finansijski podaci** (iznos, raƒçuni, datumi)
6. **Svi podaci moraju biti povezani sa zahtevima**

---

## üéØ ZAKLJUƒåAK

**Tra≈æi od e-smart pisarnice:**
- **JEDAN endpoint** `/api/pisarnica/zahtevi`
- **Svi zahtevi** (ruƒçno upisani na ≈°alterima) u jednom pozivu
- **Zahtevi sa ugro≈æenim licima** za broj XIX0255
- **JWT autentifikacija**
- **JSON format** sa UTF-8 encoding
- **Rate limiting** informacije:
  - Maksimum 1000 zahteva po minuti
  - Burst limit 100 zahteva u 10 sekundi
  - Rate limit headers (X-RateLimit-*)
  - HTTP 429 i 503 status kodovi
  - Retry policy sa eksponencijalnim backoff-om
- **Test environment** za razvoj
- **Monitoring** rate limit statusa
- **Dokumentacija** za rate limiting

**TOK: Zahtevi (pisarnica) ‚Üí Re≈°enja (tvoj softver) ‚Üí T1/T2 ‚Üí ≈†tampanje**
